# CNInputManager VC-MP 0.4中文聊天套件

> 这是一个支持04rel006及以上，针对VC-MP 0.4服务端的聊天套件，支持3700+中英文及符号字符

> 开发团伙：MP-Gamer.Com；妓术总奸：bbbb；创意贡献：Ctone

---

##  开发思路

1. 通过手动或批量手段，生成大小为指定尺寸（如25x25）的3700+(*.png)格式图片，并批量透明化，且将图片文件名更改为unicode代码；
2. 因为VC-MP Store数量限制，所以要把字库贴图全部打包为支持的xxx_unp.7z格式，然后按指定格式放到store\sprites下，作为GUI资源贴图待用；
3. 编写GUI客户端脚本，模拟出左上角GUI聊天框 -> 批量行数空间 -> 每行内动态生成45+透明贴图Sprite备用。
4. 编写服务端脚本，编写全局替换方法（Function），以供玩家只需将Message("")替换为CNInputManager_Message即可无缝使用，CNInputManager_Message的核心方法：根据脚本文件编码（ANSI）传递中文内容到客户端。
5. 客户端中文主控脚本收到来自服务端的中文字符串，这里并不能直接分割字符串来解析，因为原版松鼠语言智能分割单字节的字符串，所以需要自己编写解析代码，以检测每个字符究竟是1还是2位字节字符（因为汉字的特性，最多不超过2位），因为传统单字节文本转换为整数后永远 >= 0，所以只需要判断 `当前字节` 是否 >= 0即可得出，如果 >= 0则是传统ASNI英文或字符数字等，否则就是“异常”的双字节字符，再继续判断下一位字节，连接起来即可；
6. 判断字节后并不能直接再次转换为string，因为string转换后又变成了单字节（一个字节一个字节组成的），所以为了更加好理解，要转换为N个Array字符串数组，确保每个数组里面的值都是一个真正的“文本”。
7. 有了一个文本字符串组成的数组后，只需要遍历这个数组，同时将某行预备出来的几十个空白贴图，按照文件命名规则，SetTexture改为数组[Index]的Unicode代码，即可实现将逐个将预留出来的Alpha贴图改为里面有文字的Png贴图，反之，如果文本写完之后还剩下预留空间，则将预留空间重置为Alpha贴图，即可完成显示。
8. 编写聊天模拟逻辑，也就是新消息在最下面，如果消息框满了，会自动向上移动（最上面一条会消失）。
9. 编写字符串支持16进制颜色代码HEX，这里要用到进制转换（16转10进制），然后按照方法进行分割剔除，修改现行Sprite的Color即可完成颜色代码的支持。
10. 在服务端或客户端编写定时方法，以模拟每10秒自动依次清理最下方的聊天内容。
11. 因为该套件初期暂无更好的方法考虑到中文输入，则目前将通过GUILabel方法照常模拟英文输入输出，也就是暂时无法使用中文进行输入。具体方法：在每行的透明预制基础上，同样预制每行的空文本GUILabel，并且在服务端方面进行判定，只有在onPlayerChat聊天时，则使用GUILabel传输，否则（中文）使用上述的贴图方式（简单来说，就是每行都预留了两种显示模式，分别是贴图显示和Label显示）。
